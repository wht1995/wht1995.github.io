<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tcp 三次握手四次挥手 | VC&#39;s Blog</title>
    <meta name="description" content="记录一下叭🐌">
    
    
    <link rel="preload" href="/assets/css/0.styles.058b2d67.css" as="style"><link rel="preload" href="/assets/js/app.3d620a6f.js" as="script"><link rel="preload" href="/assets/js/7.29aba97e.js" as="script"><link rel="prefetch" href="/assets/js/10.0ab68627.js"><link rel="prefetch" href="/assets/js/11.79396d94.js"><link rel="prefetch" href="/assets/js/12.c84ca706.js"><link rel="prefetch" href="/assets/js/13.cc9287f8.js"><link rel="prefetch" href="/assets/js/14.69138d78.js"><link rel="prefetch" href="/assets/js/15.971bb51c.js"><link rel="prefetch" href="/assets/js/16.1e10d839.js"><link rel="prefetch" href="/assets/js/17.e96aff6e.js"><link rel="prefetch" href="/assets/js/18.5ee51ef9.js"><link rel="prefetch" href="/assets/js/19.dfabf67f.js"><link rel="prefetch" href="/assets/js/2.fe4a76b1.js"><link rel="prefetch" href="/assets/js/20.45e6fa32.js"><link rel="prefetch" href="/assets/js/21.9d90f167.js"><link rel="prefetch" href="/assets/js/22.bc222999.js"><link rel="prefetch" href="/assets/js/23.50e02b83.js"><link rel="prefetch" href="/assets/js/24.196726eb.js"><link rel="prefetch" href="/assets/js/25.35b23e5c.js"><link rel="prefetch" href="/assets/js/26.30b67b5e.js"><link rel="prefetch" href="/assets/js/27.dd5f26e2.js"><link rel="prefetch" href="/assets/js/28.5bb22549.js"><link rel="prefetch" href="/assets/js/29.cd1a78d5.js"><link rel="prefetch" href="/assets/js/3.b6b016ad.js"><link rel="prefetch" href="/assets/js/30.a08bb659.js"><link rel="prefetch" href="/assets/js/31.b6a25c09.js"><link rel="prefetch" href="/assets/js/4.975d3a1f.js"><link rel="prefetch" href="/assets/js/5.e5a53480.js"><link rel="prefetch" href="/assets/js/6.3c214a26.js"><link rel="prefetch" href="/assets/js/8.2c61a77c.js"><link rel="prefetch" href="/assets/js/9.c38e0b2c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.058b2d67.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">VC's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">notes</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">javaScript</a></li><li class="dropdown-item"><!----> <a href="/html/" class="nav-link">HTML/CSS</a></li><li class="dropdown-item"><!----> <a href="/http/" class="nav-link router-link-active">Http/浏览器/性能</a></li><li class="dropdown-item"><h4>后端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nodejs/" class="nav-link">NodeJs</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="https://github.com/wht1995" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">notes</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link">javaScript</a></li><li class="dropdown-item"><!----> <a href="/html/" class="nav-link">HTML/CSS</a></li><li class="dropdown-item"><!----> <a href="/http/" class="nav-link router-link-active">Http/浏览器/性能</a></li><li class="dropdown-item"><h4>后端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/nodejs/" class="nav-link">NodeJs</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="https://github.com/wht1995" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/http/" class="sidebar-link">这是HTTP的首页呀</a></li><li><a href="/http/tcp_3and4.html" class="active sidebar-link">Tcp 三次握手四次挥手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/http/tcp_3and4.html#三次握手" class="sidebar-link">三次握手</a></li><li class="sidebar-sub-header"><a href="/http/tcp_3and4.html#四次挥手" class="sidebar-link">四次挥手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/http/tcp_3and4.html#直白点帮助理解" class="sidebar-link">直白点帮助理解</a></li></ul></li><li class="sidebar-sub-header"><a href="/http/tcp_3and4.html#常见问题" class="sidebar-link">常见问题</a></li></ul></li><li><a href="/http/浏览器缓存机制.html" class="sidebar-link">浏览器缓存机制</a></li><li><a href="/http/记一次性能优化.html" class="sidebar-link">记一次性能优化</a></li><li><a href="/http/cookie.html" class="sidebar-link">前端存储</a></li><li><a href="/http/XSS.html" class="sidebar-link">XSS 攻击</a></li><li><a href="/http/CSRF.html" class="sidebar-link">CSRF 攻击</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>http基础</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="tcp-三次握手四次挥手"><a href="#tcp-三次握手四次挥手" aria-hidden="true" class="header-anchor">#</a> Tcp 三次握手四次挥手</h1> <p>TC 是面向连接的，无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。在 TCP/IP 协议中，TCP 协议提供可靠的连接服务，连接是通过三次握手进行初始化的。三次握手的目的是同步连接双方的序列号和确认号并交换 TCP窗口大小信息。</p> <h2 id="三次握手"><a href="#三次握手" aria-hidden="true" class="header-anchor">#</a> 三次握手</h2> <p><img src="/assets/img/connect.845b3d81.png" alt="tcp_connect"></p> <ul><li><p>第一次握手，客户端发送 <strong>SYN</strong> 包到服务器，表示自己想要请求连接，并进入 <strong>SYN_SENT</strong>（发送）状态，等待服务器确认。</p></li> <li><p>第二次握手，服务器接收到 <strong>SYN</strong> 包后，告诉客户端“我已经收到了”，确认客户端的 <strong>SYN（ack=x+1）</strong>，同时自己也发一个 <strong>SYN</strong> 包，即<strong>SYN + ACK</strong> 包，此时服务器进入 <strong>SYN_RECV</strong>（接收）状态。</p></li> <li><p>第三次握手，客户端收到服务器的 <strong>SYN + ACK</strong> 包后，需要向服务确认“我已经收到了”，然后向服务器发送确认包 <strong>ACK(ack=y+1)</strong> ，发送完毕后，客户端和服务器进入 <strong>ESTABLISHED</strong>（已建立）状态，完成三次握手。</p></li></ul> <p><strong>说明</strong> ：</p> <p>① <strong>SYN</strong> 和 <strong>ACK</strong> 是标志位（0或1），<strong>ACK = 1</strong> 表示 <strong>ack</strong> 有效，<strong>seq</strong> 是序列号，<strong>ack</strong> 是确认号</p> <p>② 给对方确认的方式就是把对方传来的 <strong>seq + 1</strong> 并赋值给 <strong>ack</strong></p> <h2 id="四次挥手"><a href="#四次挥手" aria-hidden="true" class="header-anchor">#</a> 四次挥手</h2> <p><img src="/assets/img/disConnect.30249e5a.png" alt="tcp_release"></p> <ul><li>客户端发送释放连接报文 <strong>FIN</strong> ，并停止发送数据。此时，客户端进入 <strong>FIN-WAIT-1</strong>（终止等待1）状态。</li> <li>服务器收到 <strong>连接释放报文</strong> 后，需要告诉客户端“我收到了”，于是发出确认报文，<strong>ACK=1</strong>，<strong>ack=u+1</strong>，并且带上自己的序列号 <strong>seq=v</strong>，此时，服务端就进入了 <strong>CLOSE-WAIT</strong>（关闭等待）状态。并且TCP服务器通知高层的应用进程，客户端向服务器请求断开连接了，这时候处于半关闭状态，即客户端已经没有数据要发送了，但是服务器若发送数据，客户端依然要接受。这个状态还要持续一段时间，也就是整个 <strong>CLOSE-WAIT</strong> 状态持续的时间。</li> <li>客户端收到来自服务端的确认报文后，便进入到了 <strong>FIN-WAIT-2</strong> （终止等待2）状态，并等待服务端发来释放连接报文（在这之前还需要接受服务器发送的最后的数据）。</li> <li>服务器将最后的数据发送完毕后，就向客户端发送连 <strong>接释放报文</strong>，<strong>FIN=1</strong>，<strong>ack=u+1</strong>，由于在半关闭状态，服务器很可能又发送了一些数据，假定此时的序列号为 <strong>seq=w</strong>，此时，服务器就进入了 <strong>LAST-ACK</strong>（最后确认）状态，等待客户端的确认。</li> <li>客户端收到服务器的 <strong>连接释放报文</strong> 后，必须告诉服务器“我收到了”，于是必须发出确认，<strong>ACK=1</strong>，<strong>ack=w+1</strong>，而自己的序列号是 <strong>seq=u+1</strong>，此时，客户端就进入了 <strong>TIME-WAIT</strong>（时间等待）状态。注意此时TCP连接 <strong>还没有释放</strong>，必须经过 <strong>2MSL</strong>（最长报文段寿命）的时间后，当客户端撤销相应的 <strong>TCB</strong>后，才进入CLOSED状态。</li> <li>服务器只要收到了客户端发出的确认，立即进入 <strong>CLOSED</strong> 状态。撤销 <strong>TCB</strong> 后，就结束了这次的TCP连接。可以看到，服务器结束TCP连接的时间要比客户端早一些。</li></ul> <p><strong>说明：</strong> <strong>TCB</strong> 是指创建的传输控制块</p> <h3 id="直白点帮助理解"><a href="#直白点帮助理解" aria-hidden="true" class="header-anchor">#</a> 直白点帮助理解</h3> <p>假设客户端发起中断连接请求，也就是发送 FIN 报文。服务端接到FIN报文后，意思是说 <strong>“我客户端没有数据要发给你了”</strong>，但是如果你还有数据没有发送完成，则不必急着关闭Socket，可以继续发送数据。所以你先发送ACK，<strong>&quot;告诉客户端，你的请求我收到了，但是我还没准备好，请继续你等我的消息&quot;</strong>。这个时候客户端就进入FIN_WAIT 状态，继续等待服务端的 FIN 报文。当服务端确定数据已发送完成，则向客户端发送 FIN 报文，<strong>&quot;告诉客户端，好了，我这边数据发完了，准备好关闭连接了&quot;</strong>。客户端收到 FIN 报文后，<strong>&quot;就知道可以关闭连接了，但是他还是不相信网络，怕服务端不知道要关闭，所以发送 ACK 后进入 TIME_WAIT 状态，如果服务端没有收到ACK 则可以重传。“</strong>，服务端收到 ACK 后，<strong>&quot;就知道可以断开连接了&quot;</strong>。客户端等待了 2MSL 后依然没有收到回复，则证明服务端已正常关闭，那好，我客户端也可以关闭连接了。Ok，TCP连接就这样关闭了！</p> <h2 id="常见问题"><a href="#常见问题" aria-hidden="true" class="header-anchor">#</a> 常见问题</h2> <p><strong>Q: 为什么连接的时候是三次握手，关闭的时候却是四次握手？</strong></p> <p><strong>A:</strong>  当客户端向服务端发送 SYN 报文请求连接时，这时没有数据传输，所以服务端可以发送一个 ACK + SYN 的报文给客户端。但是在关闭连接时，在此之前有进行数据传输，当客户端发送 FIN 请求断开连接时，很可能因为服务端还有数据没发给客户端，所以只能先回复一个 ACK 报文，告诉客户端“我收到你的断开请求了，但是我还有一些数据没发送完，所以我需要发完数据后再给你发 FIN 报文”，所以就需要四步。</p> <p><strong>Q: 为什么TIME_WAIT状态需要经过 2MSL (最大报文段生存时间)才能返回到 CLOSE 状态？</strong></p> <p><strong>A:</strong>  讲道理，四个报文都发送完毕，我们可以直接进入CLOSE状态了，但是我们必须假象网络是不可靠的，有可能客户端发送的最后一个 ACK 丢失。所以 TIME_WAIT状态就是用来重发可能丢失的 ACK 报文。在客户端发送出最后的 ACK 回复时，该ACK可能丢失。服务端如果没有收到 ACK，将不断重复发送 FIN 片段。所以客户端不能立即关闭，它必须确认服务端接收到了该 ACK 。客户端会在发送出 ACK 之后进入到 TIME_WAIT 状态。客户端会设置一个计时器，等待 2MSL 的时间。如果在该时间内再次收到来自服务端的 FIN，那么客户端会重发 ACK 并再次等待 2MSL。所谓的 2MSL 是两倍的 MSL(Maximum Segment Lifetime)。MSL指一个片段在网络中最大的存活时间，2MSL 就是一个发送和一个回复所需的最大时间。如果直到 2MSL，客户端都没有再次收到来自服务端的 FIN，那么客户推断 ACK 已经被服务端成功接收，则结束TCP连接。</p> <p><strong>Q: 如果已经建立了连接，但是客户端突然出现故障了怎么办？</strong></p> <p><strong>A:</strong> TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。</p> <p><strong>Q: 为什么不能用两次握手进行连接？</strong></p> <p><strong>A:</strong> 为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。</p> <p><strong>举例：</strong> “已失效的连接请求报文段”的产生在这样一种情况下：client 发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达 server。本来这是一个早已失效的报文段。但 server 收到此失效的连接请求报文段后，就误认为是 client 再次发出的一个新的连接请求。于是就向 client 发出确认报文段，同意建立连接。假设不采用“三次握手”，那么只要 server 发出确认，新的连接就建立了。由于现在 client 并没有发出建立连接的请求，因此不会理睬 server 的确认，也不会向 server 发送数据。但server 却以为新的运输连接已经建立，并一直等待 client 发来数据。这样，server 的很多资源就白白浪费掉了。采用“三次握手”的办法可以防止上述现象发生。例如刚才那种情况，client 不会向 server 的确认发出确认。server由于收不到确认，就知道 client 并没有要求建立连接。”</p> <p>这就很明白了，防止了服务器端的一直等待而浪费资源。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/http/" class="prev router-link-active">
          这是HTTP的首页呀
        </a></span> <span class="next"><a href="/http/浏览器缓存机制.html">
          浏览器缓存机制
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.3d620a6f.js" defer></script><script src="/assets/js/7.29aba97e.js" defer></script>
  </body>
</html>
